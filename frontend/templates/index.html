<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    {% if is_touchscreen %}
    <meta name="viewport" content="width=640, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    {% else %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    {% endif %}
    <title>Sign Detection System</title>
    <link rel="stylesheet" href="/static/css/fontawesome-local.css">
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body class="{{ 'touchscreen' if is_touchscreen else '' }}">
    {% if not is_touchscreen %}
    <!-- Landscape Prompt Overlay (mobile only) -->
    <div id="landscape-prompt" class="landscape-prompt">
        <div class="landscape-prompt-content">
            <div class="landscape-icon"><i class="fa-solid fa-mobile-screen-button"></i></div>
            <div class="landscape-title">Rotate for best experience</div>
            <div class="landscape-subtitle">This app works best in landscape</div>
            <button class="landscape-btn" onclick="dismissLandscapePrompt()">Continue Anyway</button>
        </div>
    </div>
    {% endif %}

    <!-- Brightness Overlay (CSS-based screen dimming) -->
    <div id="brightness-overlay"></div>
    <!-- Main Menu (Home Page) -->
    <div id="page-home" class="page active">
        <div class="home-container">
            <div class="home-header">
                <div class="header-actions">
                    <button class="action-btn closeapp-btn" onclick="showCloseAppConfirm()" title="Close App">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                    <button class="action-btn reboot-btn" onclick="showRebootConfirm()" title="Reboot">
                        <i class="fa-solid fa-rotate"></i>
                    </button>
                    <button class="action-btn shutdown-btn" onclick="showShutdownConfirm()" title="Shutdown">
                        <i class="fa-solid fa-power-off"></i>
                    </button>
                </div>
                <div class="status-panel">
                    <div class="status-item" id="status-wifi">
                        <span id="home-wifi-fallback" class="status-icon-indicator"><i
                                class="fa-solid fa-wifi"></i></span>
                        <span id="home-wifi-signal" class="home-signal-bars" style="display:none;"></span>
                        <span class="status-label">WiFi</span>
                    </div>
                    <div class="status-item" id="status-camera">
                        <span class="status-icon-indicator"><i class="fa-solid fa-video"></i></span>
                        <span class="status-label">Camera</span>
                    </div>
                </div>
            </div>

            <div class="menu-buttons">
                <button class="menu-btn" data-page="live">
                    <span class="icon"><i class="fa-solid fa-play"></i></span>
                    <span class="label">Live Feed</span>
                </button>

                <button class="menu-btn" data-page="settings">
                    <span class="icon"><i class="fa-solid fa-gear"></i></span>
                    <span class="label">Settings</span>
                </button>

                <button class="menu-btn" data-page="logs">
                    <span class="icon"><i class="fa-solid fa-list"></i></span>
                    <span class="label">Logs</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main id="app-content">
        <!-- Live Feed Page -->
        <div id="page-live" class="page">
            <div class="page-header">
                <button class="btn-back" onclick="goHome()"><i class="fa-solid fa-arrow-left"></i> Back</button>
                <h2>Live Feed</h2>
            </div>

            <div class="video-container-compact">
                <canvas id="video-canvas"></canvas>
                <div id="no-feed" class="no-feed">
                </div>
            </div>

            <div class="stats-bar-compact">
                <div class="stat">
                    <span class="label">FPS:</span>
                    <span id="fps-value" class="value">0</span>
                </div>
                <div class="stat">
                    <span class="label">Detected:</span>
                    <span id="detection-count" class="value">0</span>
                </div>
            </div>
        </div>

        <!-- Driving Mode Page -->
        <div id="page-driving" class="page">
            <div class="page-header">
                <button class="btn-back" onclick="goHome()"><i class="fa-solid fa-arrow-left"></i> Back</button>
                <h2>Driving Mode</h2>
            </div>

            <div class="driving-mode-selector">
                <button class="mode-btn mode-casual" id="btn-casual-mode">
                    <span class="mode-icon"><i class="fa-solid fa-flag"></i></span>
                    <span class="mode-title">Casual Mode</span>
                    <span class="mode-desc">Simple detection display</span>
                </button>

                <button class="mode-btn mode-gamified" id="btn-gamified-mode">
                    <span class="mode-icon"><i class="fa-solid fa-star"></i></span>
                    <span class="mode-title">Gamified Mode</span>
                    <span class="mode-desc">Score & achievements</span>
                </button>
            </div>
        </div>

        <!-- Logs Page -->
        <div id="page-logs" class="page">
            <div class="page-header">
                <button class="btn-back" onclick="goHome()"><i class="fa-solid fa-arrow-left"></i> Back</button>
                <h2>Violation Logs</h2>
            </div>

            <div class="controls-compact">
                <button id="btn-refresh-logs" class="btn btn-primary btn-touch" onclick="loadViolations()"><i
                        class="fa-solid fa-rotate-right"></i> Refresh</button>
                <button id="btn-clear-display" class="btn btn-secondary btn-touch" onclick="clearViolationsDisplay()"><i
                        class="fa-solid fa-xmark"></i> Clear</button>
            </div>

            <div class="violations-log-container">
                <div id="violations-list" class="violations-list"></div>
            </div>

            <!-- Detail Modal -->
            <div id="violation-detail-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Violation Details</h3>
                        <button class="btn-close" onclick="closeViolationDetail()"><i
                                class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div id="violation-detail-content" class="modal-body"></div>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="page-settings" class="page">
            <div class="page-header">
                <button class="btn-back" onclick="goHome()"><i class="fa-solid fa-arrow-left"></i> Back</button>
                <h2>Settings</h2>
            </div>

            <div class="settings-container-compact">
                <!-- Section 1: Device Settings -->
                <div class="settings-group settings-group-touch">
                    <h3>Device Settings</h3>
                    <div class="setting-row">
                        <label>Screen Brightness</label>
                        <div class="slider-container">
                            <input type="range" id="setting-brightness" class="slider-touch" min="10" max="100"
                                value="50" step="5">
                            <span id="brightness-display" class="slider-value">50%</span>
                        </div>
                    </div>
                    <div class="setting-row">
                        <label>Detection Confidence</label>
                        <div class="slider-container">
                            <input type="range" id="setting-confidence" class="slider-touch" min="0" max="100"
                                value="50" step="5">
                            <span id="confidence-display" class="slider-value">50%</span>
                        </div>
                    </div>
                    <div class="setting-row">
                        <label>Version</label>
                        <span class="setting-value">1.0.0</span>
                    </div>
                    <div class="setting-row">
                        <label>Device</label>
                        <span class="setting-value">Raspberry Pi 5</span>
                    </div>
                </div>

                <!-- Section 2: WiFi -->
                <div class="settings-group settings-group-touch">
                    <h3><i class="fa-solid fa-wifi"></i> WiFi</h3>
                    <div class="wifi-status-row">
                        <span class="wifi-label">Status</span>
                        <span id="wifi-status-text"><i class="fa fa-spinner fa-spin"></i> Checking...</span>
                    </div>
                    <div class="wifi-actions">
                        <button class="btn-wifi primary" id="btn-scan-wifi" onclick="scanWifiNetworks()">
                            <i class="fa-solid fa-magnifying-glass"></i> Scan
                        </button>
                        <button class="btn-wifi secondary" id="btn-wifi-disconnect" onclick="disconnectWifi()"
                            style="display:none;">
                            <i class="fa-solid fa-plug-circle-xmark"></i> Disconnect
                        </button>
                    </div>
                    <div id="wifi-networks-list" style="display:none;"></div>
                    <button class="btn-toggle-saved" onclick="toggleSavedNetworks()">
                        <i class="fa-solid fa-bookmark"></i> Saved Networks
                        <span id="saved-networks-toggle"><i class="fa-solid fa-chevron-down"></i></span>
                    </button>
                    <div id="wifi-saved-list" style="display:none;"></div>
                </div>

                <!-- Section 3: Hotspot -->
                <div class="settings-group settings-group-touch">
                    <h3><i class="fa-solid fa-tower-broadcast"></i> Hotspot</h3>
                    <div class="setting-row">
                        <label>Status</label>
                        <span id="hotspot-status-text" class="hotspot-status">Checking...</span>
                    </div>
                    <div class="setting-row">
                        <label>SSID</label>
                        <span id="hotspot-ssid" class="hotspot-ssid">---</span>
                    </div>
                    <div class="setting-row">
                        <button class="btn btn-hotspot-toggle btn-touch" id="hotspot-toggle-btn"
                            onclick="toggleHotspotUI()">
                            <i class="fa-solid fa-wifi"></i> <span id="hotspot-toggle-label">Enable Hotspot</span>
                        </button>
                        <button class="btn btn-primary btn-touch" id="btn-show-hotspot-qr" onclick="showHotspotQR()">
                            <i class="fa-solid fa-qrcode"></i> WiFi QR
                        </button>
                    </div>
                </div>

                <!-- Section 4: Device Pairing -->
                <div class="settings-group settings-group-touch">
                    <h3><i class="fa-solid fa-link"></i> Device Pairing</h3>
                    <div class="setting-row">
                        <label>Status</label>
                        <span id="pairing-status-badge" class="pairing-badge pairing-unpaired">
                            <i class="fa-solid fa-circle"></i> Not Paired
                        </span>
                    </div>
                    <div id="pairing-device-info" class="pairing-device-info" style="display:none;">
                        <div class="setting-row">
                            <label>Device</label>
                            <span id="pairing-device-name" class="setting-value">—</span>
                        </div>
                    </div>
                    <div class="setting-row pairing-actions">
                        <button class="btn btn-primary btn-touch" id="btn-generate-pairing"
                            onclick="generatePairingCode()">
                            <i class="fa-solid fa-qrcode"></i> Pair Device
                        </button>
                        <button class="btn btn-danger btn-touch" id="btn-unpair" onclick="unpairDevice()"
                            style="display:none;">
                            <i class="fa-solid fa-link-slash"></i> Unpair
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sticky footer buttons — outside scroll container -->
            <div class="controls-compact">
                <button id="btn-reset-settings" class="btn btn-secondary btn-touch"><i
                        class="fa-solid fa-rotate-left"></i> Reset</button>
                <button id="btn-save-settings" class="btn btn-success btn-touch"><i class="fa-solid fa-floppy-disk"></i>
                    Save</button>
            </div>
        </div>
    </main>

    <!-- WiFi Password Modal -->
    <div id="wifi-password-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Connect to WiFi</h3>
                <button class="btn-close" onclick="closeWifiModal()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <p id="wifi-connect-ssid" style="margin-bottom: 10px; font-weight: bold;"></p>
                <input type="password" id="wifi-password-input" class="input-touch" placeholder="Enter password"
                    autocomplete="off">
                <div class="wifi-modal-buttons" style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn btn-secondary btn-touch" onclick="closeWifiModal()">Cancel</button>
                    <button class="btn btn-success btn-touch" onclick="submitWifiPassword()">Connect</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hotspot QR Modal -->
    <div id="hotspot-qr-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fa-solid fa-wifi"></i> Hotspot QR</h3>
                <button class="btn-close" onclick="closeHotspotQR()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <div class="hotspot-qr-tabs">
                    <button class="hotspot-qr-tab active" onclick="switchHotspotQR('wifi')">
                        <i class="fa-solid fa-wifi"></i> WiFi
                    </button>
                    <button class="hotspot-qr-tab" onclick="switchHotspotQR('webapp')">
                        <i class="fa-solid fa-globe"></i> Web App
                    </button>
                </div>
                <div id="hotspot-wifi-qr" class="qr-image"></div>
                <div id="hotspot-webapp-qr" class="qr-image" style="display:none;"></div>
                <div class="hotspot-creds">
                    <span id="hotspot-ssid-info"></span>
                    <span id="hotspot-password-info"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Hotspot Prompt Modal -->
    <div id="hotspot-prompt-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Enable Hotspot</h3>
                <button class="btn-close" onclick="closeHotspotPrompt()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <p>This will disconnect WiFi. Proceed?</p>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn btn-secondary btn-touch" onclick="closeHotspotPrompt()">Cancel</button>
                    <button class="btn btn-success btn-touch" onclick="confirmHotspotEnable()">Enable Hotspot</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Pairing QR Modal -->
    <div id="pairing-qr-modal" class="modal" style="display:none;">
        <div class="modal-content pairing-modal-content">
            <div class="modal-header">
                <h3><i class="fa-solid fa-qrcode"></i> Pair Device</h3>
                <button class="btn-close" onclick="closePairingQR()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body pairing-modal-body">
                <div class="pairing-instructions">
                    <span class="pairing-step">1. Connect phone to hotspot</span>
                    <span class="pairing-step">2. Scan QR or enter code</span>
                </div>
                <div id="pairing-qr-image" class="pairing-qr-container"></div>
                <div class="pairing-token-row">
                    <span class="pairing-token-label">Code:</span>
                    <span id="pairing-token-display" class="pairing-token-value">--------</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container"></div>

    <!-- Shutdown Confirmation Modal -->
    <div id="shutdown-confirm-modal" class="modal shutdown-modal">
        <div class="modal-content shutdown-confirm-content">
            <div class="modal-header">
                <h3>Shutdown System?</h3>
            </div>
            <div class="modal-body shutdown-confirm-body">
                <p>Are you sure you want to shut down the Raspberry Pi?</p>
                <div class="shutdown-confirm-buttons">
                    <button class="btn btn-secondary btn-touch" onclick="cancelShutdown()">Cancel</button>
                    <button class="btn btn-danger btn-touch" onclick="confirmShutdown()">Shutdown</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Shutdown In Progress Modal -->
    <div id="shutdown-progress-modal" class="modal shutdown-modal">
        <div class="modal-content shutdown-progress-content">
            <div class="shutdown-progress-icon"><i class="fa-solid fa-power-off"></i></div>
            <div class="shutdown-progress-text">Shutting down...</div>
        </div>
    </div>

    <!-- Reboot Confirmation Modal -->
    <div id="reboot-confirm-modal" class="modal reboot-modal">
        <div class="modal-content reboot-confirm-content">
            <div class="modal-header">
                <h3>Restart System?</h3>
            </div>
            <div class="modal-body reboot-confirm-body">
                <p>Are you sure you want to restart the Raspberry Pi?</p>
                <div class="reboot-confirm-buttons">
                    <button class="btn btn-secondary btn-touch" onclick="cancelReboot()">Cancel</button>
                    <button class="btn btn-reboot btn-touch" onclick="confirmReboot()">Restart</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reboot In Progress Modal -->
    <div id="reboot-progress-modal" class="modal reboot-modal">
        <div class="modal-content reboot-progress-content">
            <div class="reboot-progress-icon"><i class="fa-solid fa-rotate"></i></div>
            <div class="reboot-progress-text">Restarting...</div>
        </div>
    </div>

    <!-- Close App Confirmation Modal -->
    <div id="closeapp-confirm-modal" class="modal closeapp-modal">
        <div class="modal-content closeapp-confirm-content">
            <div class="modal-header">
                <h3>Close the application?</h3>
            </div>
            <div class="modal-body closeapp-confirm-body">
                <p>This will stop the detection system and close the browser.</p>
                <div class="closeapp-confirm-buttons">
                    <button class="btn btn-secondary btn-touch" onclick="cancelCloseApp()">Cancel</button>
                    <button class="btn btn-closeapp btn-touch" onclick="confirmCloseApp()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Close App In Progress Modal -->
    <div id="closeapp-progress-modal" class="modal closeapp-modal">
        <div class="modal-content closeapp-progress-content">
            <div class="closeapp-progress-icon"><i class="fa-solid fa-xmark"></i></div>
            <div class="closeapp-progress-text">Closing application...</div>
        </div>
    </div>

    <!-- Unsaved Settings Modal -->
    <div id="unsaved-settings-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Unsaved Changes</h3>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px;">You have unsaved settings changes. What would you like to do?</p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-success btn-touch" onclick="saveSettingsAndGoHome()">
                        <i class="fa-solid fa-check"></i> Save
                    </button>
                    <button class="btn btn-danger btn-touch" onclick="discardSettingsAndGoHome()">
                        <i class="fa-solid fa-trash"></i> Discard
                    </button>
                    <button class="btn btn-secondary btn-touch" onclick="cancelUnsavedSettings()">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load SocketIO (bundled locally for offline/hotspot use) -->
    <script src="/static/js/socket.io.min.js"></script>
    <!-- Load our app -->
    <script src="/static/js/app.js"></script>
    {% if not is_touchscreen %}
    <script>
        // Landscape prompt logic (mobile only)
        function dismissLandscapePrompt() {
            document.getElementById('landscape-prompt').style.display = 'none';
            localStorage.setItem('tcdd_landscape_dismissed', 'true');
        }

        function checkLandscapePrompt() {
            const dismissed = localStorage.getItem('tcdd_landscape_dismissed');
            const prompt = document.getElementById('landscape-prompt');
            if (!prompt) return;
            if (dismissed === 'true' || window.innerWidth > window.innerHeight) {
                prompt.style.display = 'none';
            } else {
                prompt.style.display = 'flex';
            }
        }

        window.addEventListener('resize', checkLandscapePrompt);
        window.addEventListener('orientationchange', () => setTimeout(checkLandscapePrompt, 200));
        document.addEventListener('DOMContentLoaded', checkLandscapePrompt);
    </script>
    {% endif %}
</body>

</html>